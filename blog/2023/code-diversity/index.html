<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Attempts to measure diversity of CodeLM Generations | Reshinth Adithyan </title> <meta name="author" content="Reshinth Adithyan"> <meta name="description" content="Observing, Measuring the diversity of CodeLM Generations."> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://reshinthadithyan.github.io/blog/2023/code-diversity/"> <script src="/assets/js/theme.js?a5ca4084d3b81624bcfa01156dae2b8e"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> Reshinth Adithyan </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Attempts to measure diversity of CodeLM Generations</h1> <p class="post-meta"> March 04, 2023 </p> <p class="post-tags"> <a href="/blog/2023"> <i class="fa-solid fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/tag/codelms"> <i class="fa-solid fa-hashtag fa-sm"></i> codelms</a>   <a href="/blog/tag/analysis"> <i class="fa-solid fa-hashtag fa-sm"></i> analysis</a>   <a href="/blog/tag/benchmarking"> <i class="fa-solid fa-hashtag fa-sm"></i> benchmarking</a>   <a href="/blog/tag/lm"> <i class="fa-solid fa-hashtag fa-sm"></i> lm</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <h2 id="introduction">Introduction</h2> <p>Code Language Models are used in the context of code completion and chat interfaces day in day out by software developers to write and contribute to code bases. Programming Languages is a formal language with a fixed, strict set of rules. This pushes us to quanitify and measure how diverse are the generations generated by these models in various settings. It is also crucial to understand and define diversity in the context of code LMs. This post aims to explore and understand the diversity of generations of Code LMs. And discover various shortcomings of diversity of generations of Code LMs in a controlled setting. In the below post I use <a href="https://github.com/openai/human-eval" rel="external nofollow noopener" target="_blank">HumanEval benchmark</a> which is a benchmark evaluating function level code completion by CodeLMs for functional correctness measuring the accuracy, passing the given test cases within first <code class="language-plaintext highlighter-rouge">k</code> out of <code class="language-plaintext highlighter-rouge">n</code> samples. This post widely tries to explore how to evaluate diversity in the context of code and shortcomings of the current methods to measure diversity.</p> <h2 id="semantic-and-syntactic-diversity">Semantic and Syntactic Diversity</h2> <p>The general notion of syntax and semantics in the context of programming languages is slightly different from that of natural languages. In the context of programming languages syntax refers to the structure of the code, the rules that govern the structure of the code. Semantics refers to the intention of a given piece of code. Here is a small example of semantically similar code snippets which can be expressed varied syntax.</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/semantic_similar-480.webp 480w,/assets/img/semantic_similar-800.webp 800w,/assets/img/semantic_similar-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/semantic_similar.png" class="semantically similar code" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>The formal structure of the code allows for a wide range of syntactic variations. This is a key difference between natural languages and programming languages. Diversity of a CodeLM in the context of Code can be defined as <code class="language-plaintext highlighter-rouge">functionally equivalent, semantically similar</code> generations.</p> <h2 id="humaneval-benchmark">HumanEval Benchmark</h2> <p><a href="https://github.com/openai/human-eval" rel="external nofollow noopener" target="_blank">HumanEval benchmark</a> introduced in the <a href="https://arxiv.org/abs/2107.03374" rel="external nofollow noopener" target="_blank">Codex</a> is a popular benchmark widely used to measure the performance of CodeLMs. It is a benchmark evaluating function level code completion by CodeLMs for functional correctness measuring the accuracy, passing the given test cases within first <code class="language-plaintext highlighter-rouge">k</code> out of <code class="language-plaintext highlighter-rouge">n</code> samples.</p> <h2 id="diversity-metrics">Diversity Metrics</h2> <p>The coherent way to quantify diversity would be to look at the latent representations of different completions given a prompt. This can be done by using a good embedding model and doing some cluster analysis in the latent representation of different completion given. While this method has it’s shortcomings, it is a good starting point to quantify diversity. But the ideal end goal would be to measure how semantically diverse and functionally equivalent the generations are given a singular prompt.</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/div_pipeline-480.webp 480w,/assets/img/div_pipeline-800.webp 800w,/assets/img/div_pipeline-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/div_pipeline.png" class="diversity codeLMs" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <h2 id="limitation-of-code-embedding-models-to-model-semantics">Limitation of Code Embedding models to model semantics</h2> <p>Unlike natural language wherein, the semantics of a sentence can be understood by looking at the words and their order, in the context of programming languages, the semantics of a code snippet is not just the syntactical elements and their order. The semantics of a code snippet is also dependent on the structure of the code, the states used, the functions called, the libraries imported, etc. This makes it difficult to model the semantics of a code snippet using just the lexical tokens and their order. And this makes the model heavily biased to syntax rather than actual semantic similarity. For instance, consider three functions,</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">func_a</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="k">return</span> <span class="nf">max</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">func_b</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
  <span class="n">max_element</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">max_element</span><span class="p">:</span>
          <span class="n">max_element</span> <span class="o">=</span> <span class="n">i</span>
  <span class="k">return</span> <span class="n">max_element</span>

<span class="k">def</span> <span class="nf">func_c</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
  <span class="n">max_element</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
  <span class="k">return</span> <span class="n">max_element</span>
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">func_a</code> and <code class="language-plaintext highlighter-rouge">func_b</code> are semantically similar functionally trying to find the maximum element in a list. But <code class="language-plaintext highlighter-rouge">func_c</code> is actually bugged though naming conventions of the variable tends to be make the model map the latents to be similar. Though the actual semantically similar functional equivalent of <code class="language-plaintext highlighter-rouge">func_a</code> is <code class="language-plaintext highlighter-rouge">func_b</code>. The model tend to be severely biased towards the syntax rather than the actual semantics of the code.</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/embd_plot-480.webp 480w,/assets/img/embd_plot-800.webp 800w,/assets/img/embd_plot-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/embd_plot.png" class="Embedding dataset" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <h2 id="observations">Observations</h2> <p>For the sake of controlled experiment, we take the following models and do the analysis on the following models,</p> <ul> <li>deepseek-coder-1.3B</li> <li>deepseek-coder-6.7B</li> <li>deepseek-coder-33B</li> </ul> <p>We use <code class="language-plaintext highlighter-rouge">n_samples=10</code> and <code class="language-plaintext highlighter-rouge">temperature=0.2</code>to maintain consistency across scale. <br> The choice is with the assumption that they are trained on similar if not same amount of data and are base models with no high quality fine-tuning data encapsulated in the training run, since the dynamics of generation quality might differ post finetuning phase. We use average pairwise distance and squared sum error as the metrics to measure the closeness and tighness of the latent representations of the generations.</p> <div> <iframe width="711" height="229" seamless="" frameborder="0" scrolling="no" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vS52RmWqYdfJTxe_gfQScU3eGNIdGpZ-Zs2LqQ6rMq4tOVBiPmONN6Dn-BiC7ks3Sam6B4B7Y-XN9DP/pubchart?oid=598483660&amp;format=interactive"></iframe> </div> <p>First grasp of the results tends to conclude that the generations of the smaller models are more diverse compared to that of larger scales, but reality is quite different. A careful exploration on the generation reveals how the 1.3B model specifically generate code which has different newlines count and white space count. An easy-to-solve example of the same is shown below. In the case the 1.3B model the code was not functionally correct too.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#1.3B--example-1
</span><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">List</span> 
<span class="k">def</span> <span class="nf">has_close_elements</span><span class="p">(</span><span class="n">numbers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span><span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span> 
    <span class="n">numbers</span><span class="p">.</span><span class="nf">sort</span><span class="p">()</span> 
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">numbers</span><span class="p">)):</span> 
      <span class="k">if</span> <span class="n">numbers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">numbers</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span> 
        <span class="k">return</span> <span class="bp">True</span> 
    <span class="k">return</span> <span class="bp">False</span> 
<span class="c1">#1.3B--example-2
</span><span class="k">def</span> <span class="nf">has_close_elements</span><span class="p">(</span><span class="n">numbers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span><span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span> 
    <span class="n">numbers</span><span class="p">.</span><span class="nf">sort</span><span class="p">()</span> 
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span> <span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">numbers</span><span class="p">))</span> <span class="p">:</span> 
      <span class="k">if</span> <span class="n">numbers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">numbers</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">threshold</span> <span class="p">:</span> 
        <span class="k">return</span> <span class="bp">True</span> 
    <span class="k">return</span> <span class="bp">False</span> 
</code></pre></div></div> <p>In case of the same example generated by 6.7B and 33B model, the model consistantly the exact same code snippet.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">List</span> 
<span class="k">def</span> <span class="nf">has_close_elements</span><span class="p">(</span><span class="n">numbers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span> 
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">numbers</span><span class="p">)):</span> 
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">numbers</span><span class="p">)):</span> 
      <span class="k">if</span> <span class="nf">abs</span><span class="p">(</span><span class="n">numbers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">numbers</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span> 
        <span class="k">return</span> <span class="bp">True</span> 
  <span class="k">return</span> <span class="bp">False</span> 
</code></pre></div></div> <p>You can explore through the solutions generated by these models <a href="https://huggingface.co/spaces/reshinthadith/CodeGen-Diversity" rel="external nofollow noopener" target="_blank">here</a>.</p> <h2 id="conclusion-and-future-directions">Conclusion and Future Directions</h2> <p>Proper measure of diversity defined as <code class="language-plaintext highlighter-rouge">functionally equivalent, semantically similar</code> can act as a secondary metric to count onto in addition to performance of a model in correctness of generating solution for the given problem. When a model generates high quality diverse generations, that increases the probability of the output search space containing the solution of solving a problem in a given turn.</p> <h2 id="cite">Cite</h2> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@inproceedings{reshint-code-lm-div,
    title = "How diverse are the generations of CodeLMs ?",
    author = "Reshinth Adithyan",
    month = april,
    year = "2024"}
</code></pre></div></div> </div> </article> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Reshinth Adithyan. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/mermaid@10.7.0/dist/mermaid.min.js" integrity="sha256-TtLOdUA8mstPoO6sGvHIGx2ceXrrX4KgIItO06XOn8A=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/d3@7.8.5/dist/d3.min.js" integrity="sha256-1rA678n2xEx7x4cTZ5x4wpUCj6kUMZEZ5cxLSVSFWxw=" crossorigin="anonymous"></script> <script>let theme=determineComputedTheme();document.onreadystatechange=(()=>{"complete"===document.readyState&&(document.querySelectorAll("pre>code.language-mermaid").forEach(e=>{const t=e.textContent,d=e.parentElement;d.classList.add("unloaded");let n=document.createElement("pre");n.classList.add("mermaid");const a=document.createTextNode(t);n.appendChild(a),d.after(n)}),mermaid.initialize({theme:theme}),"undefined"!=typeof d3&&window.addEventListener("load",function(){d3.selectAll(".mermaid svg").each(function(){var e=d3.select(this);e.html("<g>"+e.html()+"</g>");var t=e.select("g"),d=d3.zoom().on("zoom",function(e){t.attr("transform",e.transform)});e.call(d)})}))});</script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?5d75c11f89cd96294bf5e6dd1ee1bb30"></script> <script defer src="/assets/js/common.js?fcfacfb8c6281f5e68d5a7d348186eb1"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>